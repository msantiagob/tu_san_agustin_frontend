---
import PostsCarousel from "./PostsCarousel";
const API = "https://wp.tusanagustin.com/wp/wp-json/wp/v2/posts?_embed&per_page=5";

// Helpers
const stripHtml = (html = "") =>
  html.replace(/<[^>]*>/g, "").replace(/&nbsp;/g, " ").trim();

const getFeatured = (p: any) => {
  const media = p?._embedded?.["wp:featuredmedia"]?.[0];
  if (!media) return { url: undefined, alt: undefined };
  return {
    url: media?.source_url,
    alt: media?.alt_text || media?.title?.rendered || "",
  };
};

// Fetch SSR (sin cachÃ©)
const res = await fetch(API, { cache: "no-store" });
if (!res.ok) {
  console.error("Error fetching posts:", res.status, await res.text());
  throw new Error("No se pudieron cargar las entradas.");
}
const posts = await res.json();

// Usar slug para rutas internas
const items = posts.map((p: any) => {
  const { url, alt } = getFeatured(p);
  const slug = p?.slug || String(p?.id);
  return {
    id: p.id,
    title: stripHtml(p?.title?.rendered || ""),
    href: `/blog/${slug}`,   //Internal link
    date: p?.date,
    image: url,
    alt,
    excerpt: stripHtml(p?.excerpt?.rendered || ""), 
  };
});
---

<section class="mx-auto w-full max-w-7xl px-4 py-10 md:px-6 lg:py-14">
  <PostsCarousel client:load items={items} className="rounded-2xl" />

  <div class="mt-4 md:hidden">
    <a
      href="/blog"
      class="inline-block rounded-full border px-4 py-2 text-sm font-medium hover:bg-muted"
    >Ver todo</a>
  </div>
</section>
