---
import '../../styles/global.css';
import Header from '@/components/pages/home/Header.astro';
import Footer from '@/components/pages/home/Footer.astro';
import { PageDetail } from '../../components/pages/PageDetail';
import { wpApi } from '../../lib/wordpress';

export async function getStaticPaths() {
  try {
    const pages = await wpApi.getPages({ per_page: 100 });
    return pages.map((page) => ({
      params: { slug: page.slug },
      props: { page }
    }));
  } catch (error) {
    console.error('Error fetching pages for static paths:', error);
    return [];
  }
}

const { page } = Astro.props;

if (!page) {
  return Astro.redirect('/404');
}

const yoastSEO = page.yoast_head_json;

const title = yoastSEO?.title || `${page.title.rendered} - Tu San Agustín`;
const description = yoastSEO?.description || (page.excerpt?.rendered
  ? wpApi.stripHtmlTags(page.excerpt.rendered)
  : `Conoce más sobre ${page.title.rendered} en Tu San Agustín`);

const canonical = yoastSEO?.canonical || page.link;
const ogImage = yoastSEO?.og_image?.[0]?.url || wpApi.extractFeaturedImage(page);
const robots = yoastSEO?.robots;
const schema = yoastSEO?.schema;
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonical} />

    <!-- Robots meta -->
    {robots && (
      <meta name="robots" content={`${robots.index || 'index'},${robots.follow || 'follow'}${robots['max-snippet'] ? `,max-snippet:${robots['max-snippet']}` : ''}${robots['max-image-preview'] ? `,max-image-preview:${robots['max-image-preview']}` : ''}${robots['max-video-preview'] ? `,max-video-preview:${robots['max-video-preview']}` : ''}`} />
    )}

    <!-- Open Graph -->
    <meta property="og:title" content={yoastSEO?.og_title || title} />
    <meta property="og:description" content={yoastSEO?.og_description || description} />
    <meta property="og:type" content={yoastSEO?.og_type || "article"} />
    <meta property="og:url" content={yoastSEO?.og_url || canonical} />
    {yoastSEO?.og_site_name && <meta property="og:site_name" content={yoastSEO.og_site_name} />}
    {yoastSEO?.og_locale && <meta property="og:locale" content={yoastSEO.og_locale} />}

    <!-- Featured image -->
    {ogImage && (
      <>
        <meta property="og:image" content={ogImage} />
        {yoastSEO?.og_image?.[0]?.width && <meta property="og:image:width" content={yoastSEO.og_image[0].width.toString()} />}
        {yoastSEO?.og_image?.[0]?.height && <meta property="og:image:height" content={yoastSEO.og_image[0].height.toString()} />}
        {yoastSEO?.og_image?.[0]?.type && <meta property="og:image:type" content={yoastSEO.og_image[0].type} />}
      </>
    )}

    <!-- Twitter Card -->
    {yoastSEO?.twitter_card && <meta name="twitter:card" content={yoastSEO.twitter_card} />}

    <!-- Article meta -->
    {yoastSEO?.article_published_time && <meta property="article:published_time" content={yoastSEO.article_published_time} />}
    {yoastSEO?.article_modified_time && <meta property="article:modified_time" content={yoastSEO.article_modified_time} />}

    <!-- Schema.org structured data -->
    {schema && (
      <script type="application/ld+json" is:inline set:html={JSON.stringify(schema)} />
    )}

    <!-- Fallback to Yoast head if available -->
    {!yoastSEO && page.yoast_head && (
      <Fragment set:html={page.yoast_head} />
    )}

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
        <link
      href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
      rel='stylesheet'
    />
  </head>
  <body>
    <Header/>
    <PageDetail client:load page={page} />
    <Footer client:load />
  </body>
</html>
